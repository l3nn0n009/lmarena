/**
 * LMArena Wrapper - Main Server
 * Express + Socket.io server for browser automation
 * Supports multiple concurrent clients with separate sessions
 */

const express = require('express');
const { createServer } = require('http');
const { Server } = require('socket.io');
const cors = require('cors');
const path = require('path');
const crypto = require('crypto');

const browserController = require('./browser');
const LMArenaController = require('./lmarena');

const app = express();
const httpServer = createServer(app);
const io = new Server(httpServer, {
    maxHttpBufferSize: 1e8, // 100MB
    connectionStateRecovery: {
        // Buffer events for disconnected clients for up to 10 minutes
        maxDisconnectionDuration: 10 * 60 * 1000,
        skipMiddlewares: true,
    },
    cors: {
        origin: "*",
        methods: ["GET", "POST"]
    }
});

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, '..', 'client', 'dist')));

// ==================== SERVER STATS ====================
const serverStats = {
    startTime: Date.now(),
    totalConnections: 0,
    activeClients: new Map(), // clientId -> { socketId, connectedAt, model, messageCount }
    totalMessages: 0,
    totalErrors: 0,
    errors: [], // Last 50 errors
    messageHistory: [], // Last 100 messages for debugging
    responseHistory: [] // Last 20 full responses for dashboard viewing
};

// Client sessions - each client gets their own LMArena instance
const clientSessions = new Map(); // clientId -> { lmarena, lastActivity }

// Generate unique client ID
function generateClientId() {
    return crypto.randomBytes(8).toString('hex');
}

// Get or create client session
async function getClientSession(clientId) {
    if (!clientSessions.has(clientId)) {
        console.log(`[Server] Creating new session for client: ${clientId} (Using Shared Controller)`);

        // Use the SHARED instance (Singleton)
        // This ensures the Dashboard and the Client use the SAME browser/cookies
        // and avoids profile locking issues.
        const lmarena = sharedLmarena;

        clientSessions.set(clientId, {
            lmarena,
            lastActivity: Date.now(),
            created: Date.now()
        });
    }

    const session = clientSessions.get(clientId);
    session.lastActivity = Date.now();
    return session;
}

// Use OPTIMIZED LMArena instance with network interception
// This is much faster and prevents browser crashes on long responses
const sharedLmarena = require('./lmarena-optimized');

// Log error to stats
function logError(error, context = '') {
    serverStats.totalErrors++;
    const errorEntry = {
        timestamp: new Date().toISOString(),
        message: error.message || String(error),
        context,
        stack: error.stack?.split('\n').slice(0, 3).join('\n')
    };
    serverStats.errors.unshift(errorEntry);
    if (serverStats.errors.length > 50) serverStats.errors.pop();
    console.error(`[Server Error] ${context}: ${error.message}`);
}

// ==================== DASHBOARD ====================
app.get('/dashboard', (req, res) => {
    const uptime = Math.floor((Date.now() - serverStats.startTime) / 1000);
    const hours = Math.floor(uptime / 3600);
    const minutes = Math.floor((uptime % 3600) / 60);
    const seconds = uptime % 60;

    const clientList = Array.from(serverStats.activeClients.entries()).map(([id, info]) => ({
        id: id.substring(0, 8) + '...',
        socketId: info.socketId.substring(0, 8) + '...',
        connectedAt: new Date(info.connectedAt).toLocaleTimeString(),
        model: info.model || 'Not selected',
        messages: info.messageCount
    }));

    const recentErrors = serverStats.errors.slice(0, 10);

    res.send(`
<!DOCTYPE html>
<html>
<head>
    <title>Grove AI Studio - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="5">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e5e5e5;
            min-height: 100vh;
            padding: 24px;
        }
        h1 { 
            font-size: 28px; 
            color: #8fb996; 
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1::before { content: 'üåø'; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 24px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            color: #8fb996;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        .stat {
            font-size: 48px;
            font-weight: 800;
            color: white;
        }
        .stat-sub {
            font-size: 14px;
            color: #888;
            margin-top: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { color: #8fb996; font-weight: 600; }
        .error-card {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        .error-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 13px;
        }
        .error-time { color: #f87171; font-weight: 600; }
        .error-msg { color: #fca5a5; margin-top: 4px; }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-green { background: #22c55e; color: black; }
        .badge-yellow { background: #facc15; color: black; }
        .refresh-note {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <h1>Grove AI Studio Dashboard</h1>
    
    <div class="grid">
        <div class="card">
            <h2>Active Users</h2>
            <div class="stat">${serverStats.activeClients.size}</div>
            <div class="stat-sub">Currently connected</div>
        </div>
        <div class="card">
            <h2>Total Connections</h2>
            <div class="stat">${serverStats.totalConnections}</div>
            <div class="stat-sub">Since server start</div>
        </div>
        <div class="card">
            <h2>Messages Sent</h2>
            <div class="stat">${serverStats.totalMessages}</div>
            <div class="stat-sub">Total prompts processed</div>
        </div>
        <div class="card">
            <h2>Uptime</h2>
            <div class="stat">${hours}h ${minutes}m</div>
            <div class="stat-sub">${seconds}s</div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 24px;">
        <h2>Connected Clients</h2>
        ${clientList.length > 0 ? `
        <table>
            <tr>
                <th>Client ID</th>
                <th>Socket</th>
                <th>Connected</th>
                <th>Model</th>
                <th>Messages</th>
            </tr>
            ${clientList.map(c => `
            <tr>
                <td><code>${c.id}</code></td>
                <td><code>${c.socketId}</code></td>
                <td>${c.connectedAt}</td>
                <td><span class="badge badge-green">${c.model}</span></td>
                <td>${c.messages}</td>
            </tr>
            `).join('')}
        </table>
        ` : '<p style="color: #888; padding: 20px 0;">No clients connected</p>'}
    </div>

    <div class="card error-card">
        <h2>Recent Errors (${serverStats.totalErrors} total)</h2>
        ${recentErrors.length > 0 ? recentErrors.map(e => `
        <div class="error-item">
            <div class="error-time">${e.timestamp} - ${e.context}</div>
            <div class="error-msg">${e.message}</div>
        </div>
        `).join('') : '<p style="color: #888; padding: 20px 0;">No errors üéâ</p>'}
    </div>

    <p class="refresh-note">Auto-refreshes every 5 seconds</p>
</body>
</html>
    `);
});

// ==================== RESPONSES DASHBOARD ====================
app.get('/responses', (req, res) => {
    const responses = serverStats.responseHistory.map(r => {
        // Escape HTML in response for display
        const escaped = (r.response || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
        return { ...r, escapedResponse: escaped };
    });

    res.send(`
<!DOCTYPE html>
<html>
<head>
    <title>Grove - Response History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="10">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Mono', 'Consolas', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 24px;
        }
        h1 { 
            font-size: 24px; 
            color: #58a6ff; 
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav { margin-bottom: 24px; }
        .nav a { color: #58a6ff; text-decoration: none; margin-right: 16px; }
        .nav a:hover { text-decoration: underline; }
        .response-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .response-header {
            background: #21262d;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #30363d;
        }
        .model-badge {
            background: #238636;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .timestamp { color: #8b949e; font-size: 12px; }
        .prompt {
            background: #1c2128;
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
            color: #8b949e;
            font-style: italic;
        }
        .response-content {
            padding: 16px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 13px;
            line-height: 1.6;
        }
        .empty { 
            text-align: center; 
            color: #8b949e;
            padding: 48px;
        }
        .tool-call {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/dashboard">‚Üê Dashboard</a>
        <a href="/responses">Responses</a>
    </div>
    <h1>üìú Response History</h1>
    
    ${responses.length > 0 ? responses.map(r => `
    <div class="response-card">
        <div class="response-header">
            <span class="model-badge">${r.model}</span>
            <span class="timestamp">${r.timestamp}</span>
        </div>
        <div class="prompt">User: ${(r.prompt || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
        <div class="response-content">${r.escapedResponse}</div>
    </div>
    `).join('') : '<div class="empty">No responses yet. Send a message via CLI or UI to see responses here.</div>'}
    
    <p style="text-align: center; color: #8b949e; margin-top: 24px; font-size: 12px;">
        Auto-refreshes every 10 seconds | Showing last ${responses.length} of max 20 responses
    </p>
</body>
</html>
    `);
});

// ==================== CLOUD COMMAND CENTER ====================
// Serve static cloud.html and provide API for data

// Serve the cloud dashboard
app.get('/cloud', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'cloud.html'));
});

// API for cloud dashboard data
app.get('/api/cloud-data', (req, res) => {
    const agents = Array.from(serverStats.activeClients.entries()).map(([id, info]) => ({
        id,
        shortId: id.substring(0, 8),
        model: info.model || 'Not selected',
        messages: info.messageCount,
        connectedAt: new Date(info.connectedAt).toLocaleTimeString()
    }));

    const responses = serverStats.responseHistory.slice(0, 5).map(r => ({
        model: r.model || 'unknown',
        shortPrompt: (r.prompt || '').substring(0, 80).replace(/</g, '&lt;').replace(/>/g, '&gt;'),
        shortResponse: (r.response || '').substring(0, 200).replace(/</g, '&lt;').replace(/>/g, '&gt;')
    }));

    const models = sharedLmarena.getAvailableModels ? sharedLmarena.getAvailableModels() : [];

    res.json({
        agents,
        responses,
        models,
        totalMessages: serverStats.totalMessages,
        responseCount: serverStats.responseHistory.length,
        uptime: Date.now() - serverStats.startTime
    });
});

// Agent detail view
app.get('/cloud/agent/:id', (req, res) => {
    const agentId = req.params.id;
    const agent = serverStats.activeClients.get(agentId);

    if (!agent) {
        return res.status(404).send('Agent not found');
    }

    const agentResponses = serverStats.responseHistory
        .filter(r => r.clientId === agentId)
        .map(r => ({
            prompt: (r.prompt || '').substring(0, 100),
            response: (r.response || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        }));

    res.send(`<!DOCTYPE html>
<html>
<head>
    <title>Agent ${agentId.substring(0, 8)}</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: #0a0a0a; color: #f5f5f5; padding: 32px; }
        a { color: #888; text-decoration: none; }
        a:hover { color: #f5f5f5; }
        h1 { font-family: 'JetBrains Mono', monospace; font-size: 24px; margin: 16px 0 8px; }
        .info { color: #888; margin-bottom: 32px; font-size: 14px; }
        .info strong { color: #f5f5f5; }
        h2 { font-size: 14px; text-transform: uppercase; color: #888; margin-bottom: 16px; }
        .response { background: #111; border: 1px solid #2a2a2a; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .response-prompt { color: #888; font-style: italic; margin-bottom: 12px; }
        .response-content { white-space: pre-wrap; font-size: 13px; line-height: 1.6; font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body>
    <a href="/cloud">Back to Cloud</a>
    <h1>${agentId.substring(0, 8)}</h1>
    <div class="info">
        Model: <strong>${agent.model || 'Not selected'}</strong> |
        Messages: <strong>${agent.messageCount}</strong> |
        Connected: <strong>${new Date(agent.connectedAt).toLocaleString()}</strong>
    </div>
    <h2>Responses</h2>
    ${agentResponses.length > 0 ? agentResponses.map(r => `
    <div class="response">
        <div class="response-prompt">"${r.prompt}..."</div>
        <div class="response-content">${r.response}</div>
    </div>
    `).join('') : '<p style="color:#555">No responses yet</p>'}
</body>
</html>`);
});

// ==================== REST API ====================
< !DOCTYPE html >
    <html>
        <head>
            <title>Grove Cloud</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
                    <style>
                        * {margin: 0; padding: 0; box-sizing: border-box; }

                        :root {
                            --bg - primary: #0a0a0a;
                        --bg-secondary: #111111;
                        --bg-tertiary: #1a1a1a;
                        --border: #2a2a2a;
                        --text-primary: #f5f5f5;
                        --text-secondary: #888888;
                        --text-muted: #555555;
                        --accent: #10b981;
                        --accent-hover: #059669;
                        --warning: #f59e0b;
                        --radius: 8px;
        }

                        body {
                            font - family: 'Space Grotesk', -apple-system, sans-serif;
                        background: var(--bg-primary);
                        color: var(--text-primary);
                        min-height: 100vh;
                        line-height: 1.5;
        }

                        .header {
                            background: var(--bg-secondary);
                        border-bottom: 1px solid var(--border);
                        padding: 16px 32px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
        }

                        .logo {
                            font - size: 20px;
                        font-weight: 700;
                        letter-spacing: -0.5px;
                        color: var(--text-primary);
        }

                        .nav {display: flex; gap: 24px; }
                        .nav a {
                            color: var(--text-secondary);
                        text-decoration: none;
                        font-size: 14px;
                        font-weight: 500;
                        transition: color 0.15s;
        }
                        .nav a:hover {color: var(--text-primary); }
                        .nav a.active {color: var(--accent); }

                        .container {padding: 32px; max-width: 1200px; margin: 0 auto; }

                        .stats {
                            display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 16px;
                        margin-bottom: 32px;
        }

                        .stat {
                            background: var(--bg-secondary);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 20px;
        }

                        .stat-value {
                            font - size: 32px;
                        font-weight: 700;
                        font-family: 'JetBrains Mono', monospace;
        }

                        .stat-label {
                            font - size: 12px;
                        color: var(--text-muted);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-top: 4px;
        }

                        .grid {display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
                        @media (max-width: 900px) { 
            .grid {grid - template - columns: 1fr; }
                        .stats {grid - template - columns: repeat(2, 1fr); }
        }

                        .panel {
                            background: var(--bg-secondary);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
        }

                        .panel-header {
                            padding: 16px 20px;
                        border-bottom: 1px solid var(--border);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
        }

                        .panel-title {
                            font - size: 14px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-secondary);
        }

                        .panel-body {padding: 20px; }

                        .agent-list {display: flex; flex-direction: column; gap: 12px; }

                        .agent {
                            background: var(--bg-tertiary);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 16px;
                        cursor: pointer;
                        transition: border-color 0.15s, background 0.15s;
        }

                        .agent:hover {
                            border - color: var(--accent);
                        background: rgba(16, 185, 129, 0.05);
        }

                        .agent-header {
                            display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
        }

                        .agent-id {
                            font - family: 'JetBrains Mono', monospace;
                        font-size: 14px;
                        font-weight: 600;
        }

                        .agent-model {
                            font - size: 12px;
                        color: var(--text-secondary);
                        background: var(--bg-primary);
                        padding: 2px 8px;
                        border-radius: 4px;
        }

                        .agent-meta {
                            font - size: 12px;
                        color: var(--text-muted);
                        display: flex;
                        gap: 16px;
        }

                        .btn {
                            background: var(--accent);
                        color: #000;
                        border: none;
                        padding: 10px 20px;
                        border-radius: var(--radius);
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                        transition: background 0.15s;
        }

                        .btn:hover {background: var(--accent-hover); }

                        .btn-secondary {
                            background: transparent;
                        border: 1px solid var(--border);
                        color: var(--text-primary);
        }

                        .btn-secondary:hover {
                            background: var(--bg-tertiary);
        }

                        .response-item {
                            padding: 12px 0;
                        border-bottom: 1px solid var(--border);
        }

                        .response-item:last-child {border - bottom: none; }

                        .response-model {
                            font - size: 11px;
                        font-family: 'JetBrains Mono', monospace;
                        color: var(--accent);
                        margin-bottom: 4px;
        }

                        .response-prompt {
                            font - size: 13px;
                        color: var(--text-secondary);
                        font-style: italic;
                        margin-bottom: 4px;
        }

                        .response-text {
                            font - size: 13px;
                        color: var(--text-muted);
                        line-height: 1.4;
        }

                        .empty {
                            text - align: center;
                        padding: 40px;
                        color: var(--text-muted);
        }

                        .form-row {
                            display: flex;
                        gap: 12px;
                        margin-top: 16px;
        }

                        .form-row input, .form-row select {
                            flex: 1;
                        background: var(--bg-primary);
                        border: 1px solid var(--border);
                        padding: 12px 16px;
                        border-radius: var(--radius);
                        color: var(--text-primary);
                        font-size: 14px;
                        font-family: inherit;
        }

                        .form-row input:focus, .form-row select:focus {
                            outline: none;
                        border-color: var(--accent);
        }

                        .form-row select option {background: var(--bg-primary); }

                        .refresh-btn {
                            font - size: 12px;
                        padding: 6px 12px;
        }

                        @keyframes pulse {
                            0 %, 100 % { opacity: 1; }
            50% {opacity: 0.5; }
        }

                        .live-dot {
                            width: 8px;
                        height: 8px;
                        background: var(--accent);
                        border-radius: 50%;
                        animation: pulse 2s infinite;
                        display: inline-block;
                        margin-right: 8px;
        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">Grove Cloud</div>
                        <div class="nav">
                            <a href="/dashboard">Dashboard</a>
                            <a href="/responses">Responses</a>
                            <a href="/cloud" class="active">Cloud</a>
                        </div>
                    </div>

                    <div class="container">
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">\${agents.length}</div>
                                <div class="stat-label">Active Agents</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">\${serverStats.totalMessages}</div>
                                <div class="stat-label">Messages</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">\${serverStats.responseHistory.length}</div>
                                <div class="stat-label">Responses</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">\${Math.floor((Date.now() - serverStats.startTime) / 60000)}m</div>
                                <div class="stat-label">Uptime</div>
                            </div>
                        </div>

                        <div class="grid">
                            <div class="panel">
                                <div class="panel-header">
                                    <span class="panel-title"><span class="live-dot"></span>Active Agents</span>
                                    <button class="btn refresh-btn" onclick="location.reload()">Refresh</button>
                                </div>
                                <div class="panel-body">
                                    \${agents.length > 0 ?\`
                                    <div class="agent-list">
                                        \${agents.map(a => \`
                                        <div class="agent" onclick="viewAgent('\${a.id}')">
                                            <div class="agent-header">
                                                <span class="agent-id">\${a.shortId}</span>
                                                <span class="agent-model">\${a.model}</span>
                                            </div>
                                            <div class="agent-meta">
                                                <span>\${a.messages} messages</span>
                                                <span>Connected \${a.connectedAt}</span>
                                            </div>
                                        </div>
                        \`).join('')}
                                    </div>
                                    \` : \`
                                    <div class="empty">
                                        <p>No agents running</p>
                                        <p style="font-size: 12px; margin-top: 8px; font-family: 'JetBrains Mono', monospace;">npm run grove</p>
                                    </div>
                    \`}
                                </div>
                            </div>

                            <div class="panel">
                                <div class="panel-header">
                                    <span class="panel-title">Recent Responses</span>
                                    <a href="/responses" style="color: var(--accent); font-size: 13px; text-decoration: none;">View All</a>
                                </div>
                                <div class="panel-body">
                                    \${recentResponses.length > 0 ? recentResponses.map(r => \`
                                    <div class="response-item">
                                        <div class="response-model">\${r.model}</div>
                                        <div class="response-prompt">"\${r.shortPrompt}..."</div>
                                        <div class="response-text">\${r.shortResponse}...</div>
                                    </div>
                                    \`).join('') : \`
                                    <div class="empty">No responses yet</div>
                    \`}
                                </div>
                            </div>
                        </div>

                        <div class="panel" style="margin-top: 24px;">
                            <div class="panel-header">
                                <span class="panel-title">Launch Agent</span>
                            </div>
                            <div class="panel-body">
                                <p style="color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                    Configure and spawn a new agent with custom context.
                                </p>
                                <form class="form-row" action="/api/agent/spawn" method="POST">
                                    <input type="text" name="project" placeholder="Project directory">
                                        <input type="text" name="context" placeholder="Context file (e.g., AGENT.md)">
                                            <select name="model">
                                                <option value="">Select Model</option>
                                                <optgroup label="Text Models">
                                                    \${textModels.map(m => \`<option value="\${m.id}">\${m.name}</option>\`).join('')}
                                                </optgroup>
                                                <optgroup label="Image Models">
                                                    \${imageModels.map(m => \`<option value="\${m.id}">\${m.name}</option>\`).join('')}
                                                </optgroup>
                                                <optgroup label="Search Models">
                                                    \${searchModels.map(m => \`<option value="\${m.id}">\${m.name}</option>\`).join('')}
                                                </optgroup>
                                            </select>
                                            <button type="submit" class="btn">Launch</button>
                                        </form>
                                    </div>
                            </div>
                        </div>

                        <script>
                            function viewAgent(id) {
                                window.location.href = '/cloud/agent/' + id;
        }
                        </script>
                </body>
            </html>
            \`);
});

// Agent detail view
app.get('/cloud/agent/:id', (req, res) => {
    const agentId = req.params.id;
            const agent = serverStats.activeClients.get(agentId);

            if (!agent) {
        return res.status(404).send('Agent not found');
    }

            const responses = serverStats.responseHistory
        .filter(r => r.clientId === agentId)
        .map(r => ({
                ...r,
                escapedResponse: (r.response || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        }));

        res.send(\`
        <!DOCTYPE html>
        <html>
            <head>
                <title>Agent \${agentId.substring(0, 8)}</title>
                <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
                    <style>
                        * {margin: 0; padding: 0; box-sizing: border-box; }
                        :root {
                            --bg - primary: #0a0a0a;
                        --bg-secondary: #111111;
                        --border: #2a2a2a;
                        --text-primary: #f5f5f5;
                        --text-secondary: #888888;
                        --accent: #10b981;
        }
                        body {
                            font - family: 'Space Grotesk', sans-serif;
                        background: var(--bg-primary);
                        color: var(--text-primary);
                        padding: 32px;
        }
                        .back {
                            color: var(--text-secondary);
                        text-decoration: none;
                        font-size: 14px;
                        margin-bottom: 24px;
                        display: inline-block;
        }
                        .back:hover {color: var(--text-primary); }
                        h1 {
                            font - size: 24px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        font-family: 'JetBrains Mono', monospace;
        }
                        .info {
                            color: var(--text-secondary);
                        font-size: 14px;
                        margin-bottom: 32px;
        }
                        .info strong {color: var(--text-primary); }
                        h2 {
                            font - size: 14px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-secondary);
                        margin-bottom: 16px;
        }
                        .response {
                            background: var(--bg-secondary);
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        margin-bottom: 16px;
                        padding: 16px;
        }
                        .response-prompt {
                            color: var(--text-secondary);
                        font-style: italic;
                        margin-bottom: 12px;
                        font-size: 14px;
        }
                        .response-content {
                            white - space: pre-wrap;
                        font-size: 13px;
                        line-height: 1.6;
                        font-family: 'JetBrains Mono', monospace;
        }
                        .empty {color: var(--text-secondary); }
                    </style>
            </head>
            <body>
                <a href="/cloud" class="back">‚Üê Back to Cloud</a>
                <h1>\${agentId.substring(0, 8)}</h1>
                <div class="info">
                    Model: <strong>\${agent.model || 'Not selected'}</strong> |
                    Messages: <strong>\${agent.messageCount}</strong> |
                    Connected: <strong>\${new Date(agent.connectedAt).toLocaleString()}</strong>
                </div>

                <h2>Responses</h2>
                \${responses.length > 0 ? responses.map(r => \`
                <div class="response">
                    <div class="response-prompt">"\${(r.prompt || '').substring(0, 100)}..."</div>
                    <div class="response-content">\${r.escapedResponse}</div>
                </div>
                \`).join('') : '<p class="empty">No responses yet</p>'}
            </body>
        </html>
        \`);
});

// ==================== REST API ====================

// Health check
app.get('/health', (req, res) => {
            res.json({ status: 'ok', activeClients: serverStats.activeClients.size });
});

// Get server stats (JSON API)
app.get('/api/stats', (req, res) => {
            res.json({
                uptime: Date.now() - serverStats.startTime,
                activeClients: serverStats.activeClients.size,
                totalConnections: serverStats.totalConnections,
                totalMessages: serverStats.totalMessages,
                totalErrors: serverStats.totalErrors,
                recentErrors: serverStats.errors.slice(0, 10)
            });
});

// Get status
app.get('/api/status', (req, res) => {
            res.json({
                browserReady: browserController.isReady,
                lmarenaInitialized: sharedLmarena.isInitialized,
                currentModel: sharedLmarena.currentModel,
                activeClients: serverStats.activeClients.size
            });
});

// Get available models
app.get('/api/models', async (req, res) => {
    try {
        const models = await sharedLmarena.getAvailableModels();
        res.json({models});
    } catch (error) {
            logError(error, 'GET /api/models');
        res.status(500).json({error: error.message });
    }
});

// Initialize LMArena
app.post('/api/init', async (req, res) => {
    try {
        const {model} = req.body || { };

        if (sharedLmarena.isInitialized) {
            return res.json({
            success: true,
        message: 'Already initialized',
        currentModel: sharedLmarena.currentModel,
        modality: sharedLmarena.currentModality
            });
        }

        const result = await sharedLmarena.initialize(model || null);
        res.json({
            success: true,
        currentModel: result?.model || null,
        modality: result?.modality || 'text'
        });
    } catch (error) {
            logError(error, 'POST /api/init');
        res.status(500).json({error: error.message });
    }
});

// Select model
app.post('/api/model', async (req, res) => {
    try {
        const {model} = req.body;
        if (!model) {
            return res.status(400).json({error: 'Model name required' });
        }

        if (!sharedLmarena.isInitialized) {
            await sharedLmarena.initialize(model);
        } else {
            await sharedLmarena.selectModel(model);
        }

        res.json({
            success: true,
        currentModel: sharedLmarena.currentModel,
        modality: sharedLmarena.currentModality
        });
    } catch (error) {
            logError(error, 'POST /api/model');
        res.status(500).json({error: error.message });
    }
});

// Send message (synchronous - waits for full response)
app.post('/api/chat', async (req, res) => {
    try {
        const {message, model} = req.body;

        if (!message) {
            return res.status(400).json({error: 'Message required' });
        }

        // Initialize if needed
        if (!sharedLmarena.isInitialized) {
            await sharedLmarena.initialize(model || null);
        }

        // Switch model if specified and different
        if (model && model !== sharedLmarena.currentModel) {
            await sharedLmarena.selectModel(model);
        }

        console.log(`[API] Chat request: ${message.substring(0, 50)}...`);
        serverStats.totalMessages++;

        // Send message and collect full response
        const result = await sharedLmarena.sendMessage(message);

        const response = typeof result === 'object' ? result.response : result;
        const chatId = typeof result === 'object' ? result.chatId : null;
        const sources = typeof result === 'object' ? (result.sources || []) : [];

        res.json({
            success: true,
        response,
        chatId,
        sources,
        model: sharedLmarena.currentModel
        });

    } catch (error) {
            logError(error, 'POST /api/chat');
        res.status(500).json({error: error.message });
    }
});

// Screenshot endpoint
app.get('/api/screenshot', async (req, res) => {
    try {
        const screenshot = await sharedLmarena.screenshot();
        res.json({screenshot: `data: image / png; base64, ${screenshot} ` });
    } catch (error) {
            logError(error, 'GET /api/screenshot');
        res.status(500).json({error: error.message });
    }
});

// ==================== SOCKET.IO ====================

io.on('connection', async (socket) => {
            // Generate or retrieve client ID
            let clientId = socket.handshake.query.clientId;
        if (!clientId || clientId === 'undefined') {
            clientId = generateClientId();
    }

        socket.clientId = clientId;
        serverStats.totalConnections++;

        // Track active client
        serverStats.activeClients.set(clientId, {
            socketId: socket.id,
        connectedAt: Date.now(),
        model: null,
        messageCount: 0
    });

        console.log(`[Server] Client connected: ${clientId} (socket: ${socket.id})`);
        console.log(`[Server] Sessions: ${clientSessions.size} `);

        // Send client their ID
        socket.emit('clientId', {clientId});

    // Helper to get this client's controller
    const getController = async () => {
        const session = await getClientSession(clientId);
        return session.lmarena;
    };

    socket.on('init', async (data) => {
        try {
            const safeData = data || { };
        console.log(`[Server] Init from client ${clientId}: `, safeData);
        socket.emit('status', {type: 'info', message: 'Launching browser...' });

        const lmarena = await getController();

        // If already initialized, just sync state
        if (lmarena.isInitialized) {
            socket.emit('models', { models: lmarena.getAvailableModels() });
        socket.emit('status', {type: 'success', message: `LMArena ready! Model: ${lmarena.currentModel || ''} `.trim() });
        socket.emit('ready', {
            initialized: true,
        currentModel: lmarena.currentModel || null,
        modality: lmarena.currentModality || 'text',
        clientId
                });
        return;
            }

        // Initialize with optional model
        const result = await lmarena.initialize(safeData.model || null);
        console.log(`[Server] LMArena initialized for ${clientId}: `, result);

        const model = result?.model || null;
        const modality = result?.modality || 'text';

        // Update client info
        if (serverStats.activeClients.has(clientId)) {
            serverStats.activeClients.get(clientId).model = model;
            }

        // Send available models
        const models = lmarena.getAvailableModels();
        socket.emit('models', {models});

        socket.emit('status', {type: 'success', message: `LMArena ready!${model ? ` Model: ${model}` : ''} ` });
        socket.emit('ready', {
            initialized: true,
        currentModel: model,
        modality: modality,
        clientId
            });
        } catch (error) {
            logError(error, `init(client: ${clientId})`);
        socket.emit('status', {type: 'error', message: error.message });
        socket.emit('error', {message: error.message, stack: error.stack });
        }
    });

    socket.on('selectModel', async (data) => {
        try {
            console.log(`[Server] Client ${clientId} selecting model: ${data.model} `);
        const lmarena = await getController();
        const result = await lmarena.selectModel(data.model);
        const success = typeof result === 'object' ? result.success : result;
        const iconUrl = typeof result === 'object' ? result.iconUrl : null;

        // Update client info
        if (serverStats.activeClients.has(clientId)) {
            serverStats.activeClients.get(clientId).model = data.model;
            }

        socket.emit('modelSelected', {success, model: data.model, iconUrl });
        } catch (error) {
            logError(error, `selectModel(client: ${clientId})`);
        socket.emit('error', {message: error.message });
        }
    });

    socket.on('loadChat', async (data) => {
        try {
            const {chatId} = data;
        const lmarena = await getController();
        const success = await lmarena.navigateToChat(chatId);
        socket.emit('chatLoaded', {success, chatId});
        } catch (error) {
            logError(error, `loadChat(client: ${clientId})`);
        socket.emit('error', {message: error.message });
        }
    });

    socket.on('sendMessage', async (data) => {
        try {
            const {message, conversationId, attachments} = data;
        console.log(`[Server] Message from client ${clientId}: ${message.substring(0, 50)}...`);

        const lmarena = await getController();

            // Handle image uploads if present
            if (attachments && attachments.length > 0) {
                for (const att of attachments) {
                    if (att.type === 'image' && att.base64) {
                        try {
            console.log(`[Server] Uploading image attachment for client ${clientId}`);
        await lmarena.uploadImage(att.base64);
                        } catch (imgErr) {
            console.error('[Server] Image upload failed:', imgErr);
        socket.emit('status', {type: 'error', message: 'Failed to upload image' });
                        }
                    }
                }
            }

        // Update stats
        serverStats.totalMessages++;
        if (serverStats.activeClients.has(clientId)) {
            serverStats.activeClients.get(clientId).messageCount++;
            }

        socket.emit('messageStart', {conversationId});

            const result = await lmarena.sendMessage(message, (tokenData) => {
            socket.emit('token', {
                fullText: tokenData.fullText,
                delta: tokenData.delta,
                imageUrl: tokenData.imageUrl,
                chatId: tokenData.chatId,
                sources: tokenData.sources || [],
                conversationId
            });
            });

        const response = typeof result === 'object' ? result.response : result;
        const chatId = typeof result === 'object' ? result.chatId : null;
        const sources = typeof result === 'object' ? (result.sources || []) : [];

        socket.emit('messageComplete', {
            response,
            chatId,
            sources,
            conversationId
        });

        // Log to history
        serverStats.messageHistory.unshift({
            clientId,
            message: message.substring(0, 100),
        timestamp: new Date().toISOString()
            });
            if (serverStats.messageHistory.length > 100) serverStats.messageHistory.pop();

        // Log FULL response for dashboard viewing
        serverStats.responseHistory.unshift({
            id: conversationId,
        clientId,
        model: lmarena.currentModel || 'unknown',
                prompt: message.substring(0, 200) + (message.length > 200 ? '...' : ''),
        response: response,
        timestamp: new Date().toISOString()
            });
            if (serverStats.responseHistory.length > 20) serverStats.responseHistory.pop();

        // Parse for tool calls if in agent mode
        const toolCalls = parseToolCalls(response);
            if (toolCalls.length > 0) {
            socket.emit('toolCalls', { toolCalls, conversationId });
            }

        } catch (error) {
            logError(error, `sendMessage(client: ${clientId})`);
        socket.emit('error', {message: error.message });
        }
    });

    socket.on('executeToolCall', async (data) => {
        try {
            const result = await executeToolCall(data.tool, data.args);
        socket.emit('toolResult', {
            tool: data.tool,
        result,
        conversationId: data.conversationId
            });
        } catch (error) {
            logError(error, `executeToolCall(client: ${clientId})`);
        socket.emit('toolError', {
            tool: data.tool,
        error: error.message
            });
        }
    });

    socket.on('disconnect', () => {
            console.log(`[Server] Client disconnected: ${clientId} `);
        serverStats.activeClients.delete(clientId);
        console.log(`[Server] Active clients: ${serverStats.activeClients.size} `);
    });
});

        // Tool call parsing (for agent mode)
        function parseToolCalls(response) {
    const toolCalls = [];

        // Simple image generation detection
        if (response.toLowerCase().includes('generate') &&
        (response.toLowerCase().includes('image') || response.toLowerCase().includes('picture'))) {
        const match = response.match(/generate\s+(?:an?\s+)?(?:image|picture)\s+(?:of\s+)?(.+?)(?:\.|$)/i);
        if (match) {
            toolCalls.push({
                tool: 'generateImage',
                args: { prompt: match[1].trim() }
            });
        }
    }

        return toolCalls;
}

        // Tool execution
        async function executeToolCall(tool, args) {
    switch (tool) {
        case 'generateImage':
        return {
            status: 'pending',
        message: `Image generation requested: ${args.prompt} `
            };

        case 'runCommand':
        return {
            status: 'blocked',
        message: 'Command execution requires user approval'
            };

        default:
        return {
            status: 'unknown',
        message: `Unknown tool: ${tool} `
            };
    }
}

// Cleanup old sessions periodically (every 5 minutes)
setInterval(() => {
    const now = Date.now();
        const timeout = 30 * 60 * 1000; // 30 minutes
        for (const [clientId, session] of clientSessions.entries()) {
        if (now - session.lastActivity > timeout) {
            console.log(`[Server] Cleaning up inactive session: ${clientId} `);
        clientSessions.delete(clientId);
        }
    }
}, 5 * 60 * 1000);

// Graceful shutdown
process.on('SIGINT', async () => {
            console.log('[Server] Shutting down...');
        await browserController.close();
        process.exit(0);
});

        const PORT = process.env.PORT || 3000;
httpServer.listen(PORT, () => {
            console.log(`[Server] Running on http://localhost:${PORT}`);
        console.log(`[Server] Dashboard at http://localhost:${PORT}/dashboard`);
        console.log('[Server] Initializing browser immediately...');

// Auto-initialize
sharedLmarena.initialize().then(() => {
            console.log('[Server] Browser initialized and ready.');
}).catch(e => {
            console.error('[Server] Browser initialization failed:', e);
});
});
